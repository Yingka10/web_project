{% extends 'base.html' %}
{% load static %}
{% block title %}聊天室{% endblock %}

{% block content %}
<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>Chat with Seller</title>
  <style>
    .chat-container {
      width: 80%;
      margin: auto;
    }
    .chat-box {
      border: 1px solid #ccc;
      padding: 20px;
      min-height: 300px;
      overflow-y: auto;
    }
    .message {
      padding: 10px;
      border-radius: 5px;
      margin: 10px 0;
      max-width: 60%;
    }
    .message.right {
      background-color: #a0e0a0;
      text-align: right;
      margin-left: auto;
    }
    .message.left {
      background-color: #f0f0f0;
      text-align: left;
    }
  </style>
</head>
<body>
  <div class="chat-container">
    <h1>聊天室</h1>
    {% if conversation.user1.id == request.user.id %}
      <p>聊天對象：{{ conversation.user2.username }}</p>
    {% else %}
      <p>聊天對象：{{ conversation.user1.username }}</p>
    {% endif %}

    <!-- 顯示對話 ID 來確認 -->
    <p>對話 ID:{{ conversation.id }}</p>

    <div id="chat-box" class="chat-box">
      <!-- 現有訊息可由伺服器渲染，也可以僅靠 WebSocket 即時加入 -->
      {% for message in messages %}
      {% if message.sender == request.user.username %}
        <div class="message right">
          <strong>{{ message.sender }}:</strong><br>
          {{ message.content }}
        </div>
      {% else %}
        <div class="message left">
          <strong>{{ message.sender }}:</strong><br>
          {{ message.content }}
        </div>
      {% endif %}
    {% empty %}
      <p>尚無訊息</p>
    {% endfor %}
    </div>

    <!-- 輸入訊息表單 -->
    <form id="chat-form">
      {% csrf_token %}
      <textarea id="message-input" rows="3" cols="50" placeholder="請輸入訊息..."></textarea><br>
      <button type="submit">送出</button>
    </form>
  </div>

  <script>
  
    // 根據使用者角色決定房間名稱前綴
    const roomPrefix = "{% if conversation.user1.id == request.user.id %}chat_buyer{% else %}chat_seller{% endif %}";
    const roomID = "{{ conversation.id }}";
    const roomName = roomPrefix + '_' + roomID;

    // 利用 console.log 印出 roomID，方便在瀏覽器中檢查它是否正確
    console.log("Generated roomID:", roomID);

    const protocol = window.location.protocol === 'https:' ? 'wss://' : 'ws://';
    const socketUrl = protocol + window.location.host + '/ws/chat/' + roomID + '/';
  

    // 用 console.log 檢查生成的 URL
    console.log('Socket URL:', socketUrl);

    const chatSocket = new WebSocket(socketUrl);

    // 當連線成功建立時
    chatSocket.onopen = function(e) {
      console.log('WebSocket 連線已建立');
    };

    // 當收到訊息時，更新聊天框內容
    chatSocket.onmessage = function(e) {
      const data = JSON.parse(e.data);
      const message = data['message'];
      const sender = data['sender'];
      const chatBox = document.getElementById('chat-box');

      // 建立新的訊息區塊
      const messageDiv = document.createElement('div');
      messageDiv.classList.add('message');

      // 判斷發送者決定顯示在左或右
      if (sender === '{{ request.user.username }}') {
        messageDiv.classList.add('right');
      } else {
        messageDiv.classList.add('left');
      }

      messageDiv.innerHTML = '<strong>' + sender + ':</strong><br>' + message;
      chatBox.appendChild(messageDiv);
      
      // 自動捲到最底部
      chatBox.scrollTop = chatBox.scrollHeight;
    };
    
    // 建立連線錯誤或連線關閉時的處理
    chatSocket.onerror = function(e) {
      console.error('WebSocket 連線錯誤:', e);
    };
    chatSocket.onclose = function(e) {
      console.error('聊天室連線意外中斷');
    };

    // 發送訊息
    document.getElementById('chat-form').onsubmit = function(e) {
      e.preventDefault();
      const messageInputDom = document.getElementById('message-input');
      const message = messageInputDom.value;
      if (message.trim() === '') {
        return;
      }
      // 確認 WebSocket 連線狀態是否處於開啟狀態
      if (chatSocket.readyState === WebSocket.OPEN) {
        chatSocket.send(JSON.stringify({
          'message': message,
          'sender': "{{ request.user.username }}"
        }));
        messageInputDom.value = '';
      } else {
        console.error('WebSocket 連線尚未開啟或已關閉');
      }
    };
  </script>
</body>
</html>
{% endblock %}