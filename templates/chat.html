{% extends 'base.html' %}
{% load static %}
{% block title %}聊天室{% endblock %}

{% block content %}
<body>
  <div class="chat-container">
    <h1>{{ conversation.user2.username }}</h1>

<div id="chat-box" class="chat-box">
  {% for message_item in messages_list %}
    {% if message_item.sender == request.user %}
      <div class="message-wrapper right">
        <!-- 移除右側的使用者名稱 -->
        <div class="message right">
          <div class="message-content">{{ message_item.content }}</div>
          <div class="message-time right">{{ message_item.timestamp|date:"H:i" }}</div>
        </div>
      </div>
    {% else %}
      <div class="message-wrapper left">
        <div class="message-sender left">{{ message_item.sender.username }}</div>
        <div class="message left">
          <div class="message-content">{{ message_item.content }}</div>
          <div class="message-time left">{{ message_item.timestamp|date:"H:i" }}</div>
        </div>
      </div>
    {% endif %}
  {% empty %}
    <p>尚無訊息</p>
  {% endfor %}
</div>
    <!-- 輸入訊息表單 -->
    <form id="chat-form" class="chat-input-container">
      {% csrf_token %}
      <textarea id="message-input" rows="3" cols="50" placeholder="請輸入訊息..."></textarea>
      <button type="submit">送出</button>
    </form>
  </div>
</body>
<script>
    window.onload = function() {
    const chatBox = document.getElementById('chat-box');
    chatBox.scrollTop = chatBox.scrollHeight;
  };
  // 根據使用者角色決定房間名稱前綴
  const roomPrefix = "{% if conversation.user1.id == request.user.id %}chat_buyer{% else %}chat_seller{% endif %}";
  const roomID = "{{ conversation.id }}";
  const roomName = roomPrefix + '_' + roomID;

  // 利用 console.log 印出 roomID，方便在瀏覽器中檢查它是否正確
  console.log("Generated roomID:", roomID);

  const protocol = window.location.protocol === 'https:' ? 'wss://' : 'ws://';
  const socketUrl = protocol + window.location.host + '/ws/chat/' + roomID + '/';


  // 用 console.log 檢查生成的 URL
  console.log('Socket URL:', socketUrl);

  const chatSocket = new WebSocket(socketUrl);

chatSocket.onmessage = function(e) {
  const data = JSON.parse(e.data);
  const messageContent = data['message'];
  const senderUsername = data['sender'];
  const timestamp = data['timestamp']; // 從 WebSocket 接收的時間
  const chatBox = document.getElementById('chat-box');

  const messageWrapperDiv = document.createElement('div');
  messageWrapperDiv.classList.add('message-wrapper');

  if (senderUsername === '{{ request.user.username }}') {
    messageWrapperDiv.classList.add('right');
  } else {
    messageWrapperDiv.classList.add('left');
  }

  const senderDiv = document.createElement('div');
  senderDiv.classList.add('message-sender');
  senderDiv.textContent = senderUsername;

  if (senderUsername === '{{ request.user.username }}') {
    senderDiv.classList.add('right');
  } else {
    senderDiv.classList.add('left');
  }

  const messageDiv = document.createElement('div');
  messageDiv.classList.add('message');
  const contentDiv = document.createElement('div');
  contentDiv.classList.add('message-content');
  contentDiv.textContent = messageContent;

  const timeDiv = document.createElement('div');
  timeDiv.classList.add('message-time');
  timeDiv.textContent = timestamp;

  if (senderUsername === '{{ request.user.username }}') {
    timeDiv.classList.add('right');
  } else {
    timeDiv.classList.add('left');
  }

  messageDiv.appendChild(contentDiv);
  messageDiv.appendChild(timeDiv);

  messageWrapperDiv.appendChild(senderDiv);
  messageWrapperDiv.appendChild(messageDiv);

  chatBox.appendChild(messageWrapperDiv);
  chatBox.scrollTop = chatBox.scrollHeight;
};
  
  // 建立連線錯誤或連線關閉時的處理
  chatSocket.onerror = function(e) {
    console.error('WebSocket 連線錯誤:', e);
  };
  chatSocket.onclose = function(e) {
    console.error('聊天室連線意外中斷');
  };

  // 發送訊息
  document.getElementById('chat-form').onsubmit = function(e) {
    e.preventDefault();
    const messageInputDom = document.getElementById('message-input');
    const messageToSend = messageInputDom.value;
    if (messageToSend.trim() === '') {
      return;
    }
    // 確認 WebSocket 連線狀態是否處於開啟狀態
    if (chatSocket.readyState === WebSocket.OPEN) {
      chatSocket.send(JSON.stringify({
        'message': messageToSend,
      }));
      messageInputDom.value = '';
    } else {
      console.error('WebSocket 連線尚未開啟或已關閉');
    }
  };
</script>
{% endblock %}