{% extends 'base.html' %}
{% load static %}
{% block title %}搜尋結果 - {{ query }}{% endblock %}

{% block content %}
<div class="container mt-5">
  <h1 class="mb-4">搜尋結果：{{ query }}</h1>
  <p>共有 {{ results.count }} 筆相關商品</p>

  <div class="row g-4">
    {% for product in results %}
    <div class="col-md-4">
      <div class="card product-card shadow-sm h-100 position-relative">
        {% if product.is_sold %}
          <span class="badge bg-danger position-absolute top-0 start-0 m-2 fs-6" style="z-index: 1; transform: rotate(-15deg);">已售出</span>
          <div class="position-absolute top-0 start-0 w-100 h-100 bg-white opacity-25" style="z-index: 0;"></div>
        {% endif %}

        {% with first_image=product.images.first %} {# 嘗試取得第一個 ProductImage 物件 #}
          {% if first_image and first_image.image and first_image.image.url %} {# 確保物件存在、圖片欄位存在、URL也存在 #}
            <img src="{{ first_image.image.url }}" class="card-img-top {% if product.is_sold %}opacity-75{% endif %}" alt="{{ product.title }}" style="height: 200px; object-fit: cover;">
          {% else %} {# 如果找不到圖片或 URL，顯示 logo #}
            <img src="{% static 'images/logo.png' %}" class="card-img-top {% if product.is_sold %}opacity-75{% endif %}" alt="預設圖片" style="height: 200px; object-fit: cover;">
          {% endif %}
        {% endwith %}
 

        <div class="card-body d-flex flex-column">
          <h5 class="card-title">{{ product.title }}</h5>
          <p class="card-text {% if product.is_sold %}text-muted text-decoration-line-through{% endif %}">{{ product.body|truncatewords:15 }}</p>
          <div class="mt-auto d-flex justify-content-between align-items-center">
            <span class="text-primary fw-bold {% if product.is_sold %}text-muted text-decoration-line-through{% endif %}">${{ product.price }}</span>
            <div>
              <a href="{% url 'product_detail' product.id %}" class="btn btn-sm {% if product.is_sold %}btn-secondary{% else %}btn-outline-primary{% endif %}">
                {% if product.is_sold %}已售出{% else %}查看詳情{% endif %}
              </a>
              {% if not product.is_sold %}
                {% if user.is_authenticated %}
                <a href="{% url 'toggle_favorite' product.id %}" class="btn btn-sm btn-outline-warning ms-2">
                  {% if user in product.favorites.all %}
                    移除收藏
                  {% else %}
                    加入收藏
                  {% endif %}
                </a>
                {% else %}
                <a href="{% url 'login' %}" class="btn btn-sm btn-outline-warning ms-2">加入收藏</a>
                {% endif %}
              {% endif %}
            </div>
          </div>
        </div>
      </div>
    </div>
    {% empty %}
    <p class="text-muted">找不到相關商品。</p>
    {% endfor %}
  </div>

  <a href="{% url 'index' %}" class="btn btn-secondary mt-4">回首頁</a>
</div>
{% endblock %}
